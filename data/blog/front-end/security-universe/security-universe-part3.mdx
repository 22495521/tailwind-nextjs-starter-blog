---
title: å‰ç«¯è³‡å®‰å®‡å®™ï¼ˆä¸‰ï¼‰- JavaScript åŸå‹éˆ XSS æ”»æ“Šï¼ˆPrototype Pollutionï¼‰
date: '2025-06-22'
tags: ['security', 'XSS', 'front-end']
draft: false
summary: 'ä½ ä»¥ç‚º XSS åªæ˜¯ `<script>` é‚£æ‹›è€æŠŠæˆ²å—ï¼Ÿå…¶å¯¦é€£ JavaScript çš„ã€ŒåŸå‹ã€éƒ½å¯èƒ½è¢«æ‹¿ä¾†æç ´å£ï¼'
---

### å‰è¨€

èº«ç‚º JavaScript é–‹ç™¼è€…ï¼Œå°ã€ŒåŸå‹éˆã€æ‡‰è©²ä¸é™Œç”Ÿå§ï¼Ÿ  
æˆ‘å€‘å¹³å¸¸å¯«ç¨‹å¼æ™‚ï¼Œå¹¾ä¹æ¯å€‹æ–¹æ³•ã€è®Šæ•¸ï¼Œç”šè‡³ç‰©ä»¶çš„è¡Œç‚ºï¼Œå…¶å¯¦éƒ½å’Œ JavaScript çš„åŸå‹ç³»çµ±æ¯æ¯ç›¸é—œã€‚

ä½†ä½ çŸ¥é“å—ï¼Ÿé€™å€‹ç†Ÿæ‚‰çš„æ©Ÿåˆ¶ï¼Œå…¶å¯¦ä¹Ÿå¯èƒ½è¢«æ‹¿ä¾†ç™¼å‹• XSS æ”»æ“Šï¼  
æˆ‘ç¬¬ä¸€æ¬¡çœ‹åˆ°é€™å€‹æŠ€å·§æ™‚ä¹Ÿè¦ºå¾—ä¸å¯æ€è­° â€”â€” åŸå‹ç«Ÿç„¶å¯ä»¥è®Šæˆæ”»æ“Šå…¥å£ï¼Ÿ  
è®“æˆ‘å€‘ä¸€èµ·ä¾†äº†è§£ï¼Œé€™èƒŒå¾Œåˆ°åº•æ˜¯æ€éº¼ä¸€å›äº‹ã€‚

---

### ä»€éº¼æ˜¯åŸå‹éˆï¼ˆPrototypeï¼‰ï¼Ÿ

å…¶å¯¦ç¶²è·¯ä¸Šå·²ç¶“æœ‰éå¸¸å¤šè¬›å¾—æ¸…æ¥šçš„æ–‡ç« ï¼Œæˆ‘é€™è£¡å°±ä¸å¤šè´…è¿°ã€‚  
æ¨è–¦é€™ç¯‡æˆ‘è¦ºå¾—æœ€å¥½æ‡‚çš„æ•™å­¸æ–‡ï¼Œæ˜¯ç”± Kuro æ‰€å¯«çš„éµäººæ–‡ç«  ğŸ‘‰  
[é‡æ–°èªè­˜ JavaScript: Day 25 åŸå‹èˆ‡ç¹¼æ‰¿](https://ithelp.ithome.com.tw/m/articles/10194356)

ç°¡å–®ä¾†èªªï¼š

> JavaScript æ˜¯ä¸€ç¨®åŸºæ–¼ã€ŒåŸå‹ç¹¼æ‰¿ã€çš„èªè¨€ã€‚  
> æ¯å€‹ç‰©ä»¶éƒ½å¯ä»¥å¾å¦ä¸€å€‹ç‰©ä»¶ç¹¼æ‰¿å±¬æ€§èˆ‡æ–¹æ³•ï¼Œé€™å€‹æ©Ÿåˆ¶å°±å«åšã€ŒåŸå‹éˆã€ã€‚

ä¾†çœ‹ä¸€å€‹ç°¡å–®çš„ä¾‹å­ï¼š

```js
// å°‡é€šç”¨çš„å±¬æ€§æ›åœ¨ Object.prototype ä¸Š
Object.prototype.canBreathe = true

// å»ºç«‹ä¸€å€‹ç‰©ä»¶
const dog = {}

console.log(dog.canBreathe) // true ğŸ‘‰ å¾ Object.prototype ç¹¼æ‰¿ä¾†çš„
```

ä½ å¯èƒ½æœƒæƒ³ï¼šã€Œæ¬¸ï¼Ÿæˆ‘æ ¹æœ¬æ²’åœ¨ `dog` è£¡é¢å»ºç«‹ä»»ä½• `canBreathe` å±¬æ€§å•Šï¼Ÿ  
ç‚ºä»€éº¼å¯ä»¥å°å‡º `true` å‘¢ï¼Ÿã€

ç­”æ¡ˆå°±æ˜¯å› ç‚º JavaScript åœ¨è®€ä¸åˆ°å±¬æ€§æ™‚ï¼Œæœƒ**æ²¿è‘—åŸå‹éˆå¾€ä¸Šæ‰¾**ï¼Œæœ€å¾Œå¾ `Object.prototype` æ‰¾åˆ° `canBreathe`ã€‚

---

### å¦‚ä½•é”æˆ Prototype XSS ï¼Ÿ

ç›´æ¥çœ‹ä¸€å€‹ç°¡å–®ç¯„ä¾‹

```js
//1.æ±¡æŸ“å±¬æ€§ï¼Œä½†æ²’æœ‰è§¸ç™¼ XSS

// æ”»æ“Šè€…å‚³å…¥çš„ payload
const payload = {
  __proto__: {
    toString: () => "<img src=x onerror=alert('XSS')>",
  },
}

// å°‡ payload åˆä½µåˆ°æŸå€‹ç‰©ä»¶ï¼ˆä¸å°å¿ƒæ±¡æŸ“åŸå‹ï¼‰
Object.assign({}, payload)

// æŸ¥çœ‹æ±¡æŸ“çµæœ
console.log({}.toString())
// è¼¸å‡ºï¼š<img src=x onerror=alert('XSS')>

//2. å‰ç«¯ä¸å°å¿ƒæŠŠç‰©ä»¶ç›´æ¥ä¸Ÿé€² innerHTML
element.innerHTML = {}.toString()
```

é€™åªæ˜¯æœ€ç°¡å–®çš„ç¤ºç¯„ï¼Œä½†å¦‚æœç³»çµ±å…§éƒ¨å¤§é‡ä¾è³´ç‰©ä»¶çš„ toString()ã€valueOf()ã€æˆ–å…¶ä»–åŸå‹æ–¹æ³•ï¼Œ
åªè¦å…¶ä¸­ä¸€è™•è¢«æ±¡æŸ“ï¼Œæ•´å€‹ç¨‹å¼é‚è¼¯å¯èƒ½æœƒéŒ¯äº‚ï¼Œç”šè‡³ç›´æ¥å´©æ½°ç„¡æ³•åŸ·è¡Œã€‚

---

### çŸ¥åå¥—ä»¶lodash

ä½ çŸ¥é“å—ï¼Ÿå°±é€£å»£æ³›ä½¿ç”¨çš„ JavaScript å·¥å…·åº« lodashï¼Œä»¥å‰ä¹Ÿæ›¾çˆ†å‡ºé Prototype Pollution æ¼æ´ï¼

ç¯„ä¾‹ï¼š

```js
const _ = require('lodash')

const obj = {}
const maliciousPayload = {
  __proto__: {
    isAdmin: true,
  },
}

_.merge(obj, maliciousPayload)

console.log({}.isAdmin) // trueï¼Œè¢«æ±¡æŸ“äº†ï¼
```

å¹¸å¥½åœ¨ä¹‹å¾Œçš„ç‰ˆæœ¬ç†ä»–åŠ å…¥äº†å°æ–¼ `__proto__`èˆ‡ `constructor`çš„éæ¿¾é€™è£¡ï¼Œå¤§è‡´å¦‚ä¸‹ï¼Œ

```js
function safeGet(object, key) {
  if (key === 'constructor' && typeof object[key] === 'function') {
    return
  }

  if (key == '__proto__') {
    return
  }

  return object[key]
}
```

é€™æ¨£ä¸€ä¾†ï¼Œå³ä½¿ä½¿ç”¨è€…å‚³å…¥æƒ¡æ„ payloadï¼Œå…§éƒ¨ä¹Ÿæœƒè·³éé€™äº›å±éšªå±¬æ€§ã€‚
é€™è£¡é™„ä¸ŠåŸå§‹ç¢¼[é€£çµ]('https://github.com/lodash/lodash/blob/main/dist/lodash.js#L6666')

---

### è©²å¦‚ä½•é é˜²å‘¢ Prototype XSS ï¼Ÿ

ä»¥ä¸‹èˆ‰äº†å¸¸è¦‹çš„äº”ç¨®ä¾‹å­ä¾†é é˜²Prototype XSS

#### 1. ä¸è¦ä½¿ç”¨ `__proto__` å’Œ `constructor`

é€™å…©å€‹ key å¯èƒ½æœƒæ±¡æŸ“ç‰©ä»¶åŸå‹ï¼Œåƒè¬ä¸è¦è®“ä½¿ç”¨è€…è¼¸å…¥ä¸­åŒ…å«é€™äº›å­—ã€‚

#### 2. ä½¿ç”¨ `Map` ä»£æ›¿ç‰©ä»¶

`Map æ²’æœ‰åŸå‹éˆï¼Œä¸æœƒè¢«æ±¡æŸ“ï¼š

```js
const obj = Object.create(null)
obj.test = 'safe'
console.log(obj.__proto__) // undefined
```

#### 3. ç”¨ `Object.create(null)` å»ºç«‹ä¹¾æ·¨ç‰©ä»¶

é€™ç¨®ç‰©ä»¶æ²’æœ‰åŸå‹ï¼Œæ¯”è¼ƒå®‰å…¨ï¼š

```js
const obj = Object.create(null)
obj.test = 'safe'
console.log(obj.__proto__) // undefined
```

#### 4. ç”¨ `Object.freeze()` é–ä½åŸå‹

å¯ä»¥è®“ Object.prototype è®Šæˆå”¯è®€ï¼Œé˜²æ­¢æ±¡æŸ“

#### 5. Node.js å¯ä»¥é—œæ‰ `__proto__`

Node.js 18+ æ”¯æ´ --disable-proto åƒæ•¸ï¼Œå¯é—œé–‰ **proto** åŠŸèƒ½ï¼š
