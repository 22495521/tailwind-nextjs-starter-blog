---
title: 前端資安宇宙（七）CORS
date: '2025-07-14'
tags: ['security', 'front-end']
draft: false
summary: 'CORS 是什麼？不是你以為的那樣'
---

## 前言

寫過前端的工程師，肯定有看過下面這個錯誤訊息：

```txt
Access to fetch at 'https://api.example.com' from origin 'http://localhost:5500' has been blocked by CORS policy
```

你第一反應可能會覺得

> 幹，我 request 寫錯了嗎？

其實你根本沒寫錯。而這其實就是我們今天要講的 **CORS（Cross-Origin Resource Sharing）**。

## 為什麼需要 CORS？

CORS 是一種**瀏覽器安全機制**，目的是為了**防止不同網域之間隨意互相存取資料**，避免惡意網站亂發請求去偷資料。想像一下，如果沒有 CORS，你在一個奇怪的網站只要點一下，它就偷偷幫你發出一個API的request，而CORS 就是為了防這種事情，讓跨來源的 request 受到瀏覽器的限制。

那我這邊先說一下解決方式，如果你要消除上面的錯誤，麻煩請跟你們的後端工程師說，cors沒有設定好，麻煩幫我加一下。

接下來，這邊先來帶大家看常見的迷思，很多人以為是cors錯誤是在發出request就被擋住了，其實是錯的喔。

### cors擋的是 request 還是 response？

流程:

```txt
① JS 發起 fetch()
   │
   ▼
② 瀏覽器收到指令 → 產生 HTTP Request
   │
   ▼
③ Request 真正飛到後端 API
   │
   ▼
④ 後端 API 處理完，回傳 Response（200 OK + JSON）
   │
   ▼
⑤ 瀏覽器收到 Response → **檢查 CORS Headers**
   │
   ├─ 若 `Access-Control-Allow-Origin` 符合：
   │      └─  把資料交給 JS → 程式成功拿到 response
   │
   └─ 若缺少或不符合：
          └─  直接丟 CORS Error
              （console 出現 *“blocked by CORS policy”*）
```

> 特別注意：Request 根本沒有被擋下來！

你以為 request 沒送成功，其實 request 有送、response 也有回來，是瀏覽器看到 response 裡沒你該有的 CORS headers，直接幫你丟錯誤，不給 JavaScript 拿資料而已，這點非常重要!!

先說以上這張圖其實是「簡單請求」的流程，他並不需要進行預檢，那究竟什麼是預檢呢?

## 「簡單請求」 vs 「非簡單請求」

不是所有跨來源請求都一樣，CORS 把它們分成「簡單請求」和「非簡單請求」，只有後者會觸發預檢（preflight）。

這邊先列出簡單請求常見的條件，如果不是簡單那就是非簡單，或是直接看文件比較快 [跨來源資源共享（CORS）](https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Guides/CORS#%E8%A8%AA%E5%95%8F%E6%8E%A7%E5%88%B6%E5%A0%B4%E6%99%AF%E7%AF%84%E4%BE%8B)

### 簡單請求條件：

- 方法是 `GET`、`POST`
- `Content-Type` 限於：
  - `application/x-www-form-urlencoded`
  - `multipart/form-data`
  - `text/plain`

只要符合以上條件，就是簡單請求。

## OPTIONS 預檢請求是什麼？

只要你發的 request 被判定是「非簡單請求」，瀏覽器就會**先送一個 OPTIONS 請求**去問後端：

> 嘿～我接下來要發一個真正的跨來源 request，這可以嗎？

這個動作稱為 Preflight Request（預檢）。

預檢流程：

```txt
① JS 發出 fetch（非簡單請求）
   │
   ▼
② 瀏覽器先送出一個 OPTIONS 請求
   │
   ▼
③ 後端回應 CORS headers（允許來源、方法、Headers）
   │
   ├─  如果 OK：
   │      → 瀏覽器接著發出原本真正的請求（如 POST、PUT）
   │
   └─  如果不 OK：
          → 直接報錯！主請求不會被送出
```

## 後端如何實作 CORS 呢？

這邊就舉例express.js的寫法供大家參考。

### 最簡單的做法：用 `cors` 套件

首先安裝套件：

```bash
npm install cors
```

接下來

```jsonld!
import express from 'express';
import cors from 'cors';

const app = express();

app.use(cors()); //  這行就開啟了 CORS（預設開放所有來源）

app.listen(3000, () => {
  console.log('Server running...');
});
```

但通常不會開放所有網站，會加入一些特定的白名單。

```js
app.use(
  cors({
    origin: 'http://localhost:5500', // 前端的網址
    credentials: true, // 允許攜帶 cookie 或自定義 header
  })
)
```

以上這就是cors常見迷思。
